name: Build APK (Volume Toolkit)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ant autoconf automake autopoint ccache cmake \
            g++ gcc git lbzip2 libffi-dev libltdl-dev libtool libssl-dev \
            make openjdk-17-jdk patch patchelf pkg-config \
            python3 python3-dev python3-pip python3-venv \
            unzip wget zip

      - name: Install python-for-android
        run: |
          python -m pip install --upgrade pip
          python -m pip install Cython==0.29.36
          python -m pip install python-for-android

      - name: Setup Android SDK + NDK
        shell: bash
        run: |
          set -euo pipefail
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          mkdir -p "$HOME/.android"
          touch "$HOME/.android/repositories.cfg"

          wget -q -O /tmp/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q /tmp/cmdline-tools.zip -d /tmp/android-cmdline-tools
          rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv /tmp/android-cmdline-tools/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"

          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" \
            platform-tools \
            "platforms;android-27" \
            "build-tools;28.0.2" \
            "ndk;25.2.9519653"

          mkdir -p "$ANDROID_SDK_ROOT/tools/bin"
          ln -sf "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
          ln -sf "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager" "$ANDROID_SDK_ROOT/tools/bin/avdmanager"

          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_TOOLS=$ANDROID_SDK_ROOT/tools" >> "$GITHUB_ENV"

      - name: Build APK with python-for-android
        shell: bash
        run: |
          set -euo pipefail
          p4a apk \
            --private . \
            --package com.hanleyai.volumetoolkit \
            --name "Volume Toolkit" \
            --version 1.0.1 \
            --bootstrap sdl2 \
            --requirements python3,kivy==2.3.0,pillow,numpy,opencv,pyjnius,requests,urllib3 \
            --permission android.permission.INTERNET \
            --permission android.permission.ACCESS_NETWORK_STATE \
            --permission android.permission.ACCESS_WIFI_STATE \
            --permission android.permission.CHANGE_WIFI_STATE \
            --permission android.permission.READ_EXTERNAL_STORAGE \
            --permission android.permission.WRITE_EXTERNAL_STORAGE \
            --orientation portrait \
            --orientation landscape \
            --arch arm64-v8a \
            --android-api 27 \
            --ndk-api 21 \
            --presplash-color "#000000" \
            --window

      - name: Collect APK(s)
        run: |
          find . -name "*.apk" -type f
          mkdir -p output
          find . -name "*.apk" -type f -exec cp {} output/ \;
          ls -lh output/

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: volumetoolkit-apk
          path: output/*.apk
